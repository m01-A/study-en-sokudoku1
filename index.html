<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI英単語学習アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { opacity: 1; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <div id="app" class="max-w-4xl mx-auto p-4 md:p-8">
        <!-- APIキー入力モーダル -->
        <div id="api-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 px-4 hidden">
            <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full space-y-4 border border-slate-100">
                <div class="flex items-center gap-2 text-indigo-600 font-bold text-xl">
                    <i data-lucide="key"></i> APIキーの設定
                </div>
                <p class="text-sm text-slate-500 leading-relaxed">例文生成機能（AI）を使用するには、Gemini APIキーが必要です。キーはあなたのブラウザにのみ保存されます。</p>
                <input type="password" id="api-key-input" placeholder="AIza..." class="w-full p-4 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500 bg-slate-50">
                <div class="flex flex-col gap-2">
                    <button onclick="saveApiKey()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-all">保存して適用</button>
                    <button onclick="document.getElementById('api-modal').classList.add('hidden')" class="w-full py-2 text-slate-400 text-sm">キャンセル</button>
                </div>
            </div>
        </div>

        <!-- 読み込み中表示 -->
        <div id="loading" class="flex flex-col items-center justify-center min-h-[60vh]">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-slate-200 border-t-indigo-600"></div>
            <p class="mt-4 text-slate-500 font-medium">単語データを読み込んでいます...</p>
        </div>

        <!-- セットアップ画面 -->
        <div id="setup-screen" class="hidden fade-in max-w-md mx-auto bg-white p-8 rounded-3xl shadow-xl border border-slate-100 space-y-8">
            <div class="flex justify-between items-start">
                <div class="space-y-1">
                    <h1 class="text-3xl font-black text-indigo-600 flex items-center gap-2 tracking-tight">
                        <i data-lucide="zap"></i> Study Vocab
                    </h1>
                    <p class="text-slate-400 font-medium">学習条件を設定してください</p>
                </div>
                <button onclick="document.getElementById('api-modal').classList.remove('hidden')" class="p-2 text-slate-300 hover:text-indigo-500 transition-colors">
                    <i data-lucide="settings"></i>
                </button>
            </div>

            <div class="space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">開始番号 (ID)</label>
                        <input type="number" id="start-idx" value="1" min="1" class="w-full p-4 bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none font-bold">
                    </div>
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">終了番号 (ID)</label>
                        <input type="number" id="end-idx" value="100" class="w-full p-4 bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none font-bold">
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">出題順序</label>
                    <div class="grid grid-cols-2 gap-2 bg-slate-50 p-1.5 rounded-2xl">
                        <button id="btn-seq" onclick="setOrder('sequential')" class="py-2.5 rounded-xl text-sm font-bold transition-all bg-white shadow-sm text-indigo-600">順番通り</button>
                        <button id="btn-ran" onclick="setOrder('random')" class="py-2.5 rounded-xl text-sm font-bold transition-all text-slate-400">ランダム</button>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">問題形式</label>
                    <select id="quiz-mode" class="w-full p-4 bg-slate-50 border-none rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none font-bold appearance-none">
                        <option value="en-to-jp">英 ⇒ 日 (意味の確認)</option>
                        <option value="jp-to-en">日 ⇒ 英 (スペル入力)</option>
                        <option value="fill-blank">例文穴埋め (AI生成)</option>
                    </select>
                </div>
            </div>

            <button onclick="startStudy()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black text-xl hover:bg-indigo-700 active:scale-[0.98] transition-all shadow-lg shadow-indigo-100 flex items-center justify-center gap-3">
                <i data-lucide="play-circle" class="w-6 h-6"></i> START
            </button>
        </div>

        <!-- クイズ画面 -->
        <div id="quiz-screen" class="hidden max-w-2xl mx-auto space-y-6">
            <div class="flex justify-between items-center px-4">
                <div class="flex items-center gap-3">
                    <span id="progress-text" class="text-xs font-black text-indigo-500 bg-indigo-50 px-4 py-2 rounded-full tracking-widest"></span>
                </div>
                <button onclick="showSetup()" class="text-xs font-bold text-slate-400 hover:text-slate-600">中断する</button>
            </div>

            <div class="bg-white p-8 md:p-16 rounded-[40px] shadow-2xl border border-slate-50 text-center min-h-[400px] flex flex-col justify-center relative overflow-hidden">
                <div id="ai-loading" class="hidden animate-pulse">
                    <i data-lucide="sparkles" class="mx-auto w-12 h-12 text-indigo-400 mb-4"></i>
                    <p class="text-indigo-500 font-bold">AIが例文を生成しています...</p>
                </div>
                
                <div id="quiz-content" class="space-y-8"></div>
                <div id="answer-area" class="hidden pt-10 mt-10 border-t border-slate-50"></div>
                
                <div class="mt-12">
                    <button id="action-btn" class="w-full py-5 bg-slate-900 text-white rounded-3xl font-black text-2xl hover:bg-black transition-all shadow-xl"></button>
                </div>
            </div>
        </div>

        <!-- 結果画面 -->
        <div id="result-screen" class="hidden text-center space-y-8 max-w-md mx-auto">
            <div class="bg-white p-12 rounded-[40px] shadow-2xl space-y-6 border border-slate-50">
                <div class="w-24 h-24 bg-green-50 text-green-500 rounded-full flex items-center justify-center mx-auto">
                    <i data-lucide="check-circle-2" class="w-12 h-12"></i>
                </div>
                <h2 class="text-3xl font-black text-slate-800">学習完了！</h2>
                <div id="final-score" class="text-7xl font-black text-indigo-600"></div>
                <p class="text-slate-400 font-medium">この調子で続けましょう！</p>
                <div class="flex flex-col gap-3 mt-10">
                    <button onclick="startStudy()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-bold text-lg">同じ条件でリトライ</button>
                    <button onclick="showSetup()" class="w-full py-4 text-slate-400 font-bold">設定に戻る</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let API_KEY = localStorage.getItem('GEMINI_API_KEY') || "";
        let allWords = [];
        let quizList = [];
        let currentIndex = 0;
        let results = [];
        let currentWord = null;
        let orderType = 'random';

        const initIcons = () => lucide.createIcons();

        const setOrder = (type) => {
            orderType = type;
            const seq = document.getElementById('btn-seq');
            const ran = document.getElementById('btn-ran');
            if (type === 'random') {
                ran.className = "py-2.5 rounded-xl text-sm font-bold transition-all bg-white shadow-sm text-indigo-600";
                seq.className = "py-2.5 rounded-xl text-sm font-bold transition-all text-slate-400";
            } else {
                seq.className = "py-2.5 rounded-xl text-sm font-bold transition-all bg-white shadow-sm text-indigo-600";
                ran.className = "py-2.5 rounded-xl text-sm font-bold transition-all text-slate-400";
            }
        };

        const loadCSV = async () => {
            // パス問題を解決するため、現在のディレクトリからの相対パスと絶対パスの両方を試す
            const filenames = ['words.csv', './words.csv', 'words.xlsx - シート1.csv', './words.xlsx - シート1.csv'];
            for (let name of filenames) {
                try {
                    const response = await fetch(name);
                    if (response.ok) {
                        const text = await response.text();
                        return parseCSV(text);
                    }
                } catch (e) { console.warn(`Failed to fetch ${name}`); }
            }
            throw new Error("CSV file not found");
        };

        const parseCSV = (text) => {
            const lines = text.split(/\r?\n/).filter(line => line.trim());
            const data = lines.map(line => {
                const matches = line.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g) || [];
                const clean = (str) => (str || "").replace(/^"|"$/g, '').trim();
                return {
                    id: parseInt(clean(matches[0])),
                    en: clean(matches[1]),
                    jp: clean(matches[2])
                };
            }).filter(w => !isNaN(w.id) && w.en && w.jp);
            return data;
        };

        window.onload = async () => {
            try {
                allWords = await loadCSV();
                if (allWords.length > 0) {
                    const maxId = Math.max(...allWords.map(w => w.id));
                    document.getElementById('end-idx').value = maxId;
                }
                showSetup();
            } catch (err) {
                document.getElementById('loading').innerHTML = `
                    <div class="text-center p-8 bg-red-50 rounded-3xl border border-red-100 max-w-sm">
                        <i data-lucide="alert-circle" class="w-12 h-12 text-red-400 mx-auto mb-4"></i>
                        <p class="text-red-600 font-bold">CSVファイルが読み込めません</p>
                        <p class="text-xs text-red-400 mt-2 leading-relaxed">リポジトリ内に「words.csv」という名前でCSVファイルが正しくアップロードされているか確認してください。</p>
                        <button onclick="location.reload()" class="mt-6 px-6 py-2 bg-red-600 text-white rounded-full text-sm font-bold">再試行</button>
                    </div>
                `;
                initIcons();
            }
        };

        const saveApiKey = () => {
            const val = document.getElementById('api-key-input').value.trim();
            if (val) {
                API_KEY = val;
                localStorage.setItem('GEMINI_API_KEY', val);
                document.getElementById('api-modal').classList.add('hidden');
            }
        };

        const showSetup = () => {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('hidden');
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            initIcons();
        };

        const startStudy = () => {
            const mode = document.getElementById('quiz-mode').value;
            if (mode === 'fill-blank' && !API_KEY) {
                document.getElementById('api-modal').classList.remove('hidden');
                return;
            }
            const start = parseInt(document.getElementById('start-idx').value);
            const end = parseInt(document.getElementById('end-idx').value);
            quizList = allWords.filter(w => w.id >= start && w.id <= end);
            
            if (quizList.length === 0) {
                alert("指定された範囲内に単語データがありません。");
                return;
            }

            if (orderType === 'random') {
                quizList = [...quizList].sort(() => Math.random() - 0.5);
            }
            currentIndex = 0;
            results = [];
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            loadNextQuiz();
        };

        const loadNextQuiz = async () => {
            if (currentIndex >= quizList.length) { showResults(); return; }
            currentWord = quizList[currentIndex];
            const mode = document.getElementById('quiz-mode').value;
            const content = document.getElementById('quiz-content');
            const answerArea = document.getElementById('answer-area');
            const actionBtn = document.getElementById('action-btn');
            const aiLoading = document.getElementById('ai-loading');

            document.getElementById('progress-text').innerText = `${currentIndex + 1} / ${quizList.length}`;
            content.innerHTML = '';
            answerArea.innerHTML = '';
            answerArea.classList.add('hidden');
            actionBtn.innerText = "CHECK ANSWER";
            actionBtn.onclick = checkAnswer;

            if (mode === 'en-to-jp') {
                content.innerHTML = `<h2 class="text-6xl font-black text-slate-800 tracking-tight">${currentWord.en}</h2>`;
            } else if (mode === 'jp-to-en') {
                content.innerHTML = `
                    <h2 class="text-3xl font-bold text-slate-500 mb-8">${currentWord.jp}</h2>
                    <input type="text" id="user-input" autocomplete="off" placeholder="英単語を入力..." class="w-full text-center text-4xl p-6 bg-slate-50 border-none rounded-[30px] outline-none focus:ring-4 focus:ring-indigo-100 transition-all font-black">
                `;
                const input = document.getElementById('user-input');
                input.focus();
                input.onkeydown = (e) => { if(e.key === 'Enter') checkAnswer(); };
            } else if (mode === 'fill-blank') {
                content.classList.add('hidden'); aiLoading.classList.remove('hidden'); actionBtn.disabled = true;
                const sentence = await generateAISentence(currentWord);
                aiLoading.classList.add('hidden'); content.classList.remove('hidden'); actionBtn.disabled = false;
                content.innerHTML = `
                    <div class="p-8 bg-indigo-50/50 rounded-[35px] text-left">
                        <p class="text-3xl font-serif text-slate-700 italic leading-snug mb-4">"${sentence.cloze}"</p>
                        <p class="text-indigo-400 font-bold text-lg">${sentence.japanese}</p>
                    </div>
                    <input type="text" id="user-input" autocomplete="off" placeholder="単語を埋める..." class="w-full text-center text-3xl p-6 bg-slate-50 border-none rounded-[30px] outline-none focus:ring-4 focus:ring-indigo-100 mt-8 font-black">
                `;
                currentWord.fullSentence = sentence.english;
                const input = document.getElementById('user-input');
                input.focus();
                input.onkeydown = (e) => { if(e.key === 'Enter') checkAnswer(); };
            }
            initIcons();
        };

        const generateAISentence = async (word) => {
            const prompt = `Word: "${word.en}" (${word.jp}). Generate a natural English example sentence. JSON: {"english": "sentence", "japanese": "translation", "cloze": "sentence with word replaced by ____"}`;
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{parts: [{text: prompt}]}], generationConfig: { responseMimeType: "application/json" } })
                });
                const data = await res.json();
                return JSON.parse(data.candidates[0].content.parts[0].text);
            } catch (e) {
                return { english: "Error.", japanese: "APIエラーが発生しました。キーを確認してください。", cloze: "____" };
            }
        };

        const checkAnswer = () => {
            const mode = document.getElementById('quiz-mode').value;
            const answerArea = document.getElementById('answer-area');
            const actionBtn = document.getElementById('action-btn');
            let isCorrect = true;

            answerArea.classList.remove('hidden');
            if (mode === 'en-to-jp') {
                answerArea.innerHTML = `<p class="text-4xl text-indigo-600 font-black">${currentWord.jp}</p>`;
            } else {
                const userVal = document.getElementById('user-input').value.trim().toLowerCase();
                isCorrect = userVal === currentWord.en.toLowerCase();
                answerArea.innerHTML = isCorrect ? 
                    `<div class="text-green-500 font-black text-2xl flex items-center justify-center gap-2 animate-bounce"><i data-lucide="check"></i> CORRECT!</div>` : 
                    `<p class="text-red-400 font-bold text-xl mb-2">INCORRECT</p><p class="text-slate-800 text-4xl font-black">${currentWord.en}</p>`;
                if (currentWord.fullSentence) {
                    answerArea.innerHTML += `<p class="mt-6 text-slate-400 italic text-sm px-6">"${currentWord.fullSentence}"</p>`;
                }
            }
            results.push({ ...currentWord, correct: isCorrect });
            actionBtn.innerText = "CONTINUE";
            actionBtn.onclick = () => { currentIndex++; loadNextQuiz(); };
            actionBtn.focus();
            initIcons();
        };

        const showResults = () => {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            const score = results.filter(r => r.correct).length;
            document.getElementById('final-score').innerText = `${score} / ${quizList.length}`;
            initIcons();
        };
    </script>
</body>
</html>

