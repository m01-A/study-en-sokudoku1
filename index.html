import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously } from 'firebase/auth';
import { Search, Play, Settings, RefreshCw, CheckCircle, XCircle, ChevronRight, ChevronLeft, HelpCircle, Loader2 } from 'lucide-react';

// --- API Configuration ---
const apiKey = ""; // Runtime provides the key

const App = () => {
  const [words, setWords] = useState([]);
  const [config, setConfig] = useState({
    startIdx: 1,
    endIdx: 100,
    isRandom: false,
    mode: 'en-to-jp', // 'en-to-jp', 'jp-to-en', 'fill-blank'
  });
  const [gameState, setGameState] = useState('setup'); // 'setup', 'playing', 'finished'
  const [currentIndex, setCurrentIndex] = useState(0);
  const [currentQuiz, setCurrentQuiz] = useState(null);
  const [userInput, setUserInput] = useState('');
  const [isCorrect, setIsCorrect] = useState(null); // null, true, false
  const [results, setResults] = useState([]);
  const [isLoading, setIsLoading] = useState(false);
  const [quizList, setQuizList] = useState([]);

  // Load CSV data
  useEffect(() => {
    const loadCSV = async () => {
      try {
        const response = await fetch('words.xlsx - シート1.csv');
        const text = await response.text();
        const rows = text.split('\n').filter(row => row.trim() !== '');
        const parsedWords = rows.map(row => {
          // Handle potential commas inside quotes in CSV
          const parts = row.match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g) || [];
          return {
            id: parseInt(parts[0]?.replace(/"/g, '')),
            en: parts[1]?.replace(/"/g, '').trim(),
            jp: parts[2]?.replace(/"/g, '').trim(),
          };
        }).filter(w => !isNaN(w.id) && w.en && w.jp);
        
        setWords(parsedWords);
        if (parsedWords.length > 0) {
          setConfig(prev => ({ ...prev, endIdx: parsedWords.length }));
        }
      } catch (error) {
        console.error("Failed to load CSV", error);
      }
    };
    loadCSV();
  }, []);

  // AI Sentence Generation logic
  const generateSentence = async (word) => {
    setIsLoading(true);
    const systemPrompt = "あなたは英語教師です。指定された英単語を使用した、短くて実用的な例文（英語）とその日本語訳を1組作成してください。";
    const userQuery = `単語: "${word.en}" (${word.jp})。
    以下のJSON形式で返してください。
    {
      "english": "The full English sentence with the word in it.",
      "japanese": "例文の日本語訳",
      "cloze": "The sentence with the word replaced by '____'."
    }`;

    try {
      let retryCount = 0;
      const backoff = (ms) => new Promise(res => setTimeout(res, ms));

      while (retryCount < 5) {
        try {
          const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [{ text: userQuery }] }],
              systemInstruction: { parts: [{ text: systemPrompt }] },
              generationConfig: { responseMimeType: "application/json" }
            })
          });

          if (!response.ok) throw new Error('API request failed');
          
          const data = await response.json();
          const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
          const result = JSON.parse(resultText);
          setIsLoading(false);
          return result;
        } catch (err) {
          retryCount++;
          await backoff(Math.pow(2, retryCount) * 1000);
        }
      }
      throw new Error('Retries exhausted');
    } catch (error) {
      setIsLoading(false);
      return {
        english: `Example sentence for ${word.en} could not be generated.`,
        japanese: "例文を生成できませんでした。",
        cloze: `____ is a useful word.`
      };
    }
  };

  const startStudy = async () => {
    const filtered = words.filter(w => w.id >= config.startIdx && w.id <= config.endIdx);
    let list = [...filtered];
    if (config.isRandom) {
      list = list.sort(() => Math.random() - 0.5);
    }
    
    setQuizList(list);
    setCurrentIndex(0);
    setResults([]);
    setGameState('playing');
    loadNextQuiz(list, 0);
  };

  const loadNextQuiz = async (list, index) => {
    const word = list[index];
    if (!word) {
      setGameState('finished');
      return;
    }

    if (config.mode === 'fill-blank') {
      const sentenceData = await generateSentence(word);
      setCurrentQuiz({ ...word, ...sentenceData });
    } else {
      setCurrentQuiz(word);
    }
    setIsCorrect(null);
    setUserInput('');
  };

  const checkAnswer = () => {
    const answer = userInput.trim().toLowerCase();
    const correct = currentQuiz.en.toLowerCase();
    
    // Simple logic for jp-to-en and fill-blank. 
    // For en-to-jp, we usually just show the answer since JP matching is hard.
    let isRight = false;
    if (config.mode === 'en-to-jp') {
      isRight = true; // Manual confirmation for JP
    } else {
      isRight = (answer === correct);
    }

    setIsCorrect(isRight);
    setResults(prev => [...prev, { ...currentQuiz, userResult: isRight }]);
  };

  const handleNext = () => {
    const nextIdx = currentIndex + 1;
    if (nextIdx < quizList.length) {
      setCurrentIndex(nextIdx);
      loadNextQuiz(quizList, nextIdx);
    } else {
      setGameState('finished');
    }
  };

  const renderSetup = () => (
    <div className="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-xl space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
      <div className="text-center space-y-2">
        <h1 className="text-3xl font-bold text-indigo-600 flex items-center justify-center gap-2">
          <Search className="w-8 h-8" /> 単語学習AI
        </h1>
        <p className="text-gray-500">範囲と形式を選んでスタート！</p>
      </div>

      <div className="space-y-4">
        <div className="grid grid-cols-2 gap-4">
          <div className="space-y-1">
            <label className="text-sm font-medium text-gray-700">開始番号</label>
            <input 
              type="number" 
              value={config.startIdx}
              onChange={(e) => setConfig({...config, startIdx: parseInt(e.target.value)})}
              className="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
            />
          </div>
          <div className="space-y-1">
            <label className="text-sm font-medium text-gray-700">終了番号</label>
            <input 
              type="number" 
              value={config.endIdx}
              onChange={(e) => setConfig({...config, endIdx: parseInt(e.target.value)})}
              className="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
            />
          </div>
        </div>

        <div className="space-y-2">
          <label className="text-sm font-medium text-gray-700">出題順</label>
          <div className="flex bg-gray-100 p-1 rounded-lg">
            <button 
              onClick={() => setConfig({...config, isRandom: false})}
              className={`flex-1 py-2 rounded-md text-sm font-medium transition-all ${!config.isRandom ? 'bg-white shadow-sm text-indigo-600' : 'text-gray-500'}`}
            >
              順番通り
            </button>
            <button 
              onClick={() => setConfig({...config, isRandom: true})}
              className={`flex-1 py-2 rounded-md text-sm font-medium transition-all ${config.isRandom ? 'bg-white shadow-sm text-indigo-600' : 'text-gray-500'}`}
            >
              ランダム
            </button>
          </div>
        </div>

        <div className="space-y-2">
          <label className="text-sm font-medium text-gray-700">出題形式</label>
          <select 
            value={config.mode}
            onChange={(e) => setConfig({...config, mode: e.target.value})}
            className="w-full p-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none appearance-none bg-white"
          >
            <option value="en-to-jp">英 ⇒ 日 (意味の確認)</option>
            <option value="jp-to-en">日 ⇒ 英 (スペル入力)</option>
            <option value="fill-blank">例文穴埋め (AI生成)</option>
          </select>
        </div>
      </div>

      <button 
        onClick={startStudy}
        disabled={words.length === 0}
        className="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold text-lg hover:bg-indigo-700 active:scale-[0.98] transition-all flex items-center justify-center gap-2 disabled:bg-gray-300"
      >
        {words.length === 0 ? <Loader2 className="animate-spin" /> : <Play className="fill-current" />}
        学習を開始する
      </button>
    </div>
  );

  const renderPlaying = () => {
    if (isLoading) return (
      <div className="flex flex-col items-center justify-center min-h-[400px] space-y-4">
        <Loader2 className="w-12 h-12 text-indigo-500 animate-spin" />
        <p className="text-indigo-600 font-medium animate-pulse">AIが例文を生成中...</p>
      </div>
    );

    if (!currentQuiz) return null;

    return (
      <div className="max-w-2xl mx-auto space-y-6 animate-in zoom-in-95 duration-300">
        <div className="flex justify-between items-center px-4">
          <span className="text-sm font-bold text-indigo-500 bg-indigo-50 px-3 py-1 rounded-full">
            No. {currentQuiz.id} | {currentIndex + 1} / {quizList.length}
          </span>
          <button 
            onClick={() => setGameState('setup')}
            className="text-sm text-gray-400 hover:text-gray-600 flex items-center gap-1"
          >
            中止して戻る
          </button>
        </div>

        <div className="bg-white p-10 rounded-3xl shadow-xl border border-gray-100 text-center space-y-8">
          {config.mode === 'en-to-jp' && (
            <div className="space-y-6">
              <h2 className="text-5xl font-extrabold text-gray-800 tracking-tight">{currentQuiz.en}</h2>
              {isCorrect !== null && (
                <div className="animate-in slide-in-from-top-4 duration-300">
                  <p className="text-2xl text-indigo-600 font-bold">{currentQuiz.jp}</p>
                </div>
              )}
            </div>
          )}

          {config.mode === 'jp-to-en' && (
            <div className="space-y-6">
              <h2 className="text-3xl font-bold text-gray-800">{currentQuiz.jp}</h2>
              <input 
                autoFocus
                type="text"
                placeholder="英単語を入力..."
                value={userInput}
                onChange={(e) => setUserInput(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && isCorrect === null && checkAnswer()}
                disabled={isCorrect !== null}
                className={`w-full text-center text-3xl p-4 border-b-4 outline-none transition-colors ${
                  isCorrect === null ? 'border-gray-100 focus:border-indigo-400' : 
                  isCorrect ? 'border-green-400 text-green-600' : 'border-red-400 text-red-600'
                }`}
              />
              {isCorrect === false && (
                <p className="text-lg font-bold text-red-500 animate-bounce">正解: {currentQuiz.en}</p>
              )}
            </div>
          )}

          {config.mode === 'fill-blank' && (
            <div className="space-y-6 text-left">
              <div className="p-6 bg-gray-50 rounded-2xl border border-gray-100 italic font-serif text-2xl text-gray-700 leading-relaxed">
                "{currentQuiz.cloze}"
              </div>
              <p className="text-gray-500 text-lg px-2">{currentQuiz.japanese}</p>
              
              <div className="pt-4">
                <input 
                  autoFocus
                  type="text"
                  placeholder="空欄に当てはまる英単語を入力..."
                  value={userInput}
                  onChange={(e) => setUserInput(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && isCorrect === null && checkAnswer()}
                  disabled={isCorrect !== null}
                  className={`w-full text-center text-2xl p-4 border-b-4 outline-none transition-colors ${
                    isCorrect === null ? 'border-gray-100 focus:border-indigo-400' : 
                    isCorrect ? 'border-green-400 text-green-600' : 'border-red-400 text-red-600'
                  }`}
                />
              </div>
              
              {isCorrect !== null && (
                <div className="mt-4 p-4 bg-indigo-50 rounded-xl animate-in fade-in duration-500">
                  <p className="text-indigo-600 font-bold text-xl mb-1">Answer: {currentQuiz.en}</p>
                  <p className="text-gray-700 italic">"{currentQuiz.english}"</p>
                </div>
              )}
            </div>
          )}

          <div className="pt-6">
            {isCorrect === null ? (
              <button 
                onClick={checkAnswer}
                className="w-full py-4 bg-gray-800 text-white rounded-xl font-bold text-xl hover:bg-black transition-all"
              >
                答え合わせ
              </button>
            ) : (
              <button 
                autoFocus
                onClick={handleNext}
                className="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold text-xl hover:bg-indigo-700 flex items-center justify-center gap-2 animate-in pulse duration-1000 infinite"
              >
                次へ進む <ChevronRight />
              </button>
            )}
          </div>
        </div>
      </div>
    );
  };

  const renderFinished = () => {
    const score = results.filter(r => r.userResult).length;
    return (
      <div className="max-w-2xl mx-auto space-y-6 animate-in slide-in-from-bottom-10 duration-700">
        <div className="bg-white p-10 rounded-3xl shadow-2xl text-center space-y-6 border border-indigo-50">
          <div className="w-24 h-24 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
            <CheckCircle className="w-12 h-12" />
          </div>
          <h2 className="text-4xl font-black text-gray-800">学習完了！</h2>
          <div className="text-6xl font-black text-indigo-600">
            {score} <span className="text-2xl text-gray-400">/ {quizList.length}</span>
          </div>
          <p className="text-gray-500">お疲れ様でした。定着するまで繰り返し挑戦しましょう。</p>
          
          <div className="flex gap-4">
            <button 
              onClick={() => setGameState('setup')}
              className="flex-1 py-4 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition-all"
            >
              設定に戻る
            </button>
            <button 
              onClick={startStudy}
              className="flex-1 py-4 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-all"
            >
              同じ条件で再挑戦
            </button>
          </div>
        </div>

        <div className="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100">
          <div className="p-4 bg-gray-50 font-bold text-gray-700 border-b">学習履歴</div>
          <div className="divide-y divide-gray-50">
            {results.map((res, i) => (
              <div key={i} className="p-4 flex justify-between items-center hover:bg-gray-50 transition-colors">
                <div>
                  <p className="font-bold text-gray-800">{res.en}</p>
                  <p className="text-sm text-gray-500">{res.jp}</p>
                </div>
                {res.userResult ? (
                  <CheckCircle className="text-green-500 w-6 h-6" />
                ) : (
                  <XCircle className="text-red-500 w-6 h-6" />
                )}
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-gray-900 p-4 md:p-8">
      <div className="max-w-4xl mx-auto">
        {gameState === 'setup' && renderSetup()}
        {gameState === 'playing' && renderPlaying()}
        {gameState === 'finished' && renderFinished()}
      </div>
    </div>
  );
};

export default App;
